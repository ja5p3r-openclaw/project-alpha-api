<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“ˆ</text></svg>">
    <title>Project Alpha | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #030712; --glass: rgba(17, 24, 39, 0.7); --border: rgba(255, 255, 255, 0.08); }
        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: var(--bg); 
            background-image: radial-gradient(circle at 50% -20%, #1e293b 0%, #030712 100%);
            color: #f8fafc; min-height: 100vh;
        }
        .glass { background: var(--glass); backdrop-filter: blur(12px); border: 1px solid var(--border); }
        .accent-gradient { background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%); }
        .text-gradient { background: linear-gradient(to right, #38bdf8, #818cf8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        input { background: rgba(0,0,0,0.2); border: 1px solid var(--border); color: white; border-radius: 12px; padding: 12px; }
        button { border-radius: 12px; font-weight: bold; transition: all 0.2s; }
        button:hover { transform: translateY(-2px); opacity: 0.9; }
    </style>
</head>
<body class="p-6 md:p-12">
    <div id="auth-screen" class="max-w-md mx-auto mt-20 space-y-8 text-center">
        <h1 class="text-4xl font-bold tracking-tight">Project <span class="text-gradient">Alpha</span></h1>
        <div class="glass p-8 rounded-3xl space-y-4">
            <h2 id="auth-title" class="text-xl font-bold">Secure Access</h2>
            <div id="login-fields" class="flex flex-col gap-4 text-left">
                <div>
                    <label class="text-xs text-slate-500 uppercase ml-1">Username</label>
                    <input type="text" id="username" class="w-full mt-1 outline-none focus:border-sky-500" placeholder="ja5p3r">
                </div>
                <div>
                    <label class="text-xs text-slate-500 uppercase ml-1">Password</label>
                    <input type="password" id="password" class="w-full mt-1 outline-none focus:border-sky-500" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <div id="2fa-field" class="hidden">
                    <label class="text-xs text-slate-500 uppercase ml-1">Security PIN (2FA)</label>
                    <input type="text" id="pin" class="w-full mt-1 outline-none focus:border-sky-500" placeholder="123456">
                </div>
            </div>
            <button id="auth-btn" onclick="handleAuth()" class="w-full accent-gradient py-3 mt-4 text-white">Login to Console</button>
            <p id="auth-msg" class="text-xs text-red-400 mt-2 min-h-[1em]"></p>
        </div>
    </div>

    <div id="main-dashboard" class="hidden max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-12">
            <div>
                <h1 class="text-3xl font-bold tracking-tight mb-1">Project <span class="text-gradient">Alpha</span></h1>
                <p id="user-welcome" class="text-slate-500 text-sm">Welcome back, Developer</p>
            </div>
            <button onclick="logout()" class="text-xs text-slate-500 hover:text-white transition-colors">Logout Session</button>
        </header>

        <!-- API Key Manager -->
        <div class="glass p-8 rounded-3xl mb-8 border-sky-500/20 bg-sky-500/5">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h2 class="text-xl font-bold">API Access Key</h2>
                    <p class="text-slate-400 text-xs">Used for authentication in all production requests.</p>
                </div>
                <div class="flex gap-2 w-full md:w-auto">
                    <input type="password" id="api-key-display" readonly value="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="bg-black/40 border-none flex-grow md:w-64 font-mono text-sm">
                    <button onclick="toggleKey()" class="bg-white/10 px-4 py-2 text-xs">Show</button>
                    <button onclick="copyKey()" class="accent-gradient px-4 py-2 text-xs">Copy</button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 space-y-8">
                <!-- Forex Card -->
                <div class="glass rounded-3xl p-8">
                    <h2 class="text-lg font-bold mb-6">Currency (USD/INR)</h2>
                    <div id="forex-content">
                        <div class="text-4xl font-bold text-gradient">â‚¹--.--</div>
                    </div>
                </div>

                <!-- GST Validator -->
                <div class="glass rounded-3xl p-8">
                    <h2 class="text-lg font-bold mb-4">GST Validator</h2>
                    <div class="space-y-4">
                        <input type="text" id="gst-input" placeholder="Enter GSTIN..." class="w-full text-sm">
                        <button onclick="checkGST()" class="w-full bg-white text-black py-2.5 text-sm font-bold">Verify</button>
                    </div>
                    <div id="gst-result" class="mt-4 hidden p-4 rounded-xl text-xs font-mono"></div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="glass rounded-3xl p-8">
                    <h2 class="text-xl font-bold mb-6 text-white">Mandi Price Index</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="text-slate-500 text-[10px] uppercase tracking-widest border-b border-white/5">
                                <tr><th class="pb-4">Commodity</th><th class="pb-4">State</th><th class="pb-4 text-right">Price</th></tr>
                            </thead>
                            <tbody id="mandi-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Plans -->
        <div class="mt-8 grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="glass p-5 rounded-2xl border-white/5 opacity-60">
                <p class="text-[10px] font-bold text-slate-500 uppercase">Free</p>
                <h3 class="text-lg font-bold mt-1">â‚¹0</h3>
            </div>
            <div class="glass p-5 rounded-2xl border-yellow-500/30 bg-yellow-500/5">
                <p class="text-[10px] font-bold text-yellow-500 uppercase">Gold</p>
                <h3 class="text-lg font-bold mt-1">â‚¹60</h3>
            </div>
            <div class="glass p-5 rounded-2xl border-sky-500/50 bg-sky-500/5">
                <p class="text-[10px] font-bold text-sky-500 uppercase">Diamond</p>
                <h3 class="text-lg font-bold mt-1">â‚¹1k</h3>
            </div>
            <div class="glass p-5 rounded-2xl border-purple-500/30 bg-purple-500/5">
                <p class="text-[10px] font-bold text-purple-400 uppercase">Obsidian</p>
                <h3 class="text-lg font-bold mt-1">Custom</h3>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let requires2FA = false;

        async function handleAuth() {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const pin = document.getElementById('pin').value;
            const msg = document.getElementById('auth-msg');
            msg.innerText = "";

            try {
                const res = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: user, password: pass, pin: pin })
                });
                const data = await res.json();

                if (res.status === 200) {
                    if (data.status === 'need_2fa') {
                        requires2FA = true;
                        document.getElementById('2fa-field').classList.remove('hidden');
                        msg.innerText = "PIN required (check console for now)";
                        console.log("2FA PIN IS:", data.debug_pin);
                    } else {
                        currentUser = data;
                        showDashboard();
                    }
                } else {
                    msg.innerText = data.detail || "Authentication Failed";
                }
            } catch (err) { msg.innerText = "Connection error."; }
        }

        function showDashboard() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-dashboard').classList.remove('hidden');
            document.getElementById('user-welcome').innerText = `Active Session: ${currentUser.username} (${currentUser.plan})`;
            updateDashboard();
        }

        function logout() { location.reload(); }

        function toggleKey() {
            const el = document.getElementById('api-key-display');
            el.type = el.type === 'password' ? 'text' : 'password';
        }

        function copyKey() {
            const key = currentUser.api_key;
            navigator.clipboard.writeText(key);
            alert("API Key copied to clipboard");
        }

        async function updateDashboard() {
            const key = currentUser.api_key;
            try {
                const fx = await fetch('/api/v1/forex/usd-inr', { headers: { 'X-API-Key': key } });
                const fxData = await fx.json();
                if (fxData.status === 'success') {
                    document.getElementById('forex-content').innerHTML = `<div class="text-4xl font-bold text-gradient">â‚¹${fxData.data.rate}</div>`;
                }

                const mandi = await fetch('/api/v1/mandi/snapshot', { headers: { 'X-API-Key': key } });
                const mData = await mandi.json();
                if (mData.status === 'success') {
                    document.getElementById('mandi-body').innerHTML = mData.data.map(i => `
                        <tr class="border-b border-white/5"><td class="py-3">${i.commodity}</td><td>${i.state}</td><td class="text-right font-bold">â‚¹${i.modal_price}</td></tr>
                    `).join('');
                }
            } catch (err) {}
        }

        async function checkGST() {
            const gstin = document.getElementById('gst-input').value;
            const resDiv = document.getElementById('gst-result');
            resDiv.classList.remove('hidden');
            resDiv.innerHTML = 'Verifying...';
            try {
                const res = await fetch(`/api/v1/gst/verify/${gstin}`, { headers: { 'X-API-Key': currentUser.api_key } });
                const data = await res.json();
                if (res.status === 200) {
                    resDiv.className = 'mt-4 p-4 rounded-xl text-xs font-mono bg-green-500/10 text-green-400 border border-green-500/20';
                    resDiv.innerHTML = `SUCCESS: Valid GSTIN Found.`;
                } else {
                    resDiv.className = 'mt-4 p-4 rounded-xl text-xs font-mono bg-red-500/10 text-red-400 border border-red-500/20';
                    resDiv.innerHTML = `FAILED: ${data.detail || data.message}`;
                }
            } catch (err) { resDiv.innerHTML = 'Network Error.'; }
        }
    </script>
</body>
</html>
